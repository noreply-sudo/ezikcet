<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>EziKCET</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="EziKCET">

    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <style>
        :root {
            --primary: #007bff;       
            --primary-dark: #0056b3;
            --accent: #ff4757;        
            --bg: #ffffff;            
            --text: #222222;
            --text-light: #666666;
            --border: #e1e1e1;
            --radius: 18px;           
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            color: var(--text);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .app-container {
            width: 100%;
            max-width: 460px;
            padding: 25px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* --- BRANDING --- */
        .brand-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 35px;
            margin-top: 15px;
            text-align: center;
        }

        /* The App Icon Image */
        .app-logo {
            width: 120px;
            height: 120px;
            border-radius: 28px; /* Smooth rounded corners like iOS */
            box-shadow: 0 15px 35px rgba(0,123,255,0.2);
            margin-bottom: 20px;
            object-fit: cover;
        }

        .brand-header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--text);
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .brand-header p {
            margin: 5px 0 0;
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* --- SCREENS --- */
        .screen {
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .screen.active { display: flex; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- INSTALL PROMPT SCREEN --- */
        #install-screen {
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }
        .install-instruction {
            background: #f8f9fa;
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: var(--text-light);
            line-height: 1.5;
            text-align: center;
        }

        /* --- FORMS --- */
        .form-group { margin-bottom: 20px; position: relative; }
        label {
            display: block; margin-bottom: 8px; font-weight: 600;
            font-size: 0.85rem; color: var(--text); text-transform: uppercase;
        }
        input, select {
            width: 100%; padding: 16px; border: 2px solid var(--border);
            border-radius: var(--radius); font-size: 1rem; box-sizing: border-box;
            background: #fcfcfc; transition: all 0.2s; -webkit-appearance: none;
        }
        input:focus, select:focus {
            outline: none; border-color: var(--primary); background: #fff;
        }
        
        /* Dropdown Arrow */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px;
        }

        /* Toggle Password */
        .password-wrapper { position: relative; }
        .toggle-password {
            position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
            cursor: pointer; color: var(--text-light); font-size: 1.2rem; padding: 5px;
        }

        /* BUTTONS */
        .btn {
            width: 100%; padding: 18px; background: var(--primary); color: #fff;
            border: none; border-radius: var(--radius); font-size: 1.1rem;
            font-weight: 700; cursor: pointer; margin-top: 15px;
            box-shadow: 0 10px 20px -10px rgba(0,123,255,0.5); transition: 0.2s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-link {
            background: none; color: var(--primary); padding: 15px; margin-top: 5px;
            font-size: 0.95rem; font-weight: 600; width: 100%; border: none; cursor: pointer;
        }

        /* DASHBOARD */
        .dashboard-card {
            background: linear-gradient(135deg, #f0f7ff, #e6f2ff);
            padding: 25px; border-radius: 20px; border: none;
            box-shadow: var(--shadow); margin-bottom: 25px;
        }

        /* GRID SYSTEM */
        .section-title {
            margin: 20px 0 15px 0; font-size: 1.1rem; color: var(--text); font-weight: 700;
        }
        .subject-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .card-link {
            background: white; border: none; color: var(--text); padding: 20px 10px;
            border-radius: 18px; text-align: center; font-weight: 700;
            text-decoration: none; display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-shadow: var(--shadow);
            font-size: 1rem; position: relative; overflow: hidden; transition: 0.2s;
        }
        .card-link:active { transform: scale(0.96); }
        
        .subject-card::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 5px;
            background: var(--primary); opacity: 0.7;
        }
        .test-card::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 5px;
            background: var(--accent); opacity: 0.7;
        }

        /* LOADER */
        #loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); display: none;
            justify-content: center; align-items: center; z-index: 999;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(0,123,255,0.1); border-top: 4px solid var(--primary);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="brand-header">
            <img src="icon.png" alt="EziKCET App Logo" class="app-logo">
            <h1>EziKCET</h1>
            <p>KCET support by Ezi Nurse</p>
        </div>

        <div id="loader">
            <div class="spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>

        <div id="install-screen" class="screen">
            <h2 style="font-size: 1.4rem; text-align: center;">Install App</h2>
            <p style="color: var(--text-light); margin-bottom: 20px; text-align: center;">
                Please install EziKCET on your device to access the study materials.
            </p>
            
            <button id="install-btn" class="btn" style="display: none;">
                ‚¨áÔ∏è Install App
            </button>

            <div id="ios-instruction" class="install-instruction" style="display: none;">
                <strong>For iPhone/iPad:</strong><br>
                1. Tap the <strong>Share</strong> button <span style="font-size:1.2rem">‚éã</span><br>
                2. Scroll down & tap <strong>"Add to Home Screen" ‚ûï</strong>
            </div>
            
            </div>

        <div id="login-screen" class="screen">
            <h2 style="margin: 0 0 5px 0; font-size: 1.5rem;">Welcome back!</h2>
            <p style="margin: 0 0 30px 0; color: var(--text-light);">Login to start learning.</p>
            
            <form id="login-form">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="login-email" required placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="login-password" required placeholder="Enter password">
                        <span class="toggle-password" onclick="toggleVisibility('login-password')">üëÅÔ∏è</span>
                    </div>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            <button class="btn btn-link" onclick="showScreen('forgot-screen')">Forgot Password?</button>
            <button class="btn btn-link" style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 20px;" onclick="showScreen('signup-screen')">New here? <span style="color:var(--primary);">Sign Up</span></button>
        </div>

        <div id="signup-screen" class="screen">
            <h2 style="margin-bottom: 20px;">Create Account</h2>
            <form id="signup-form">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="reg-name" required placeholder="Your Name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="reg-email" required placeholder="john@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="reg-password" required placeholder="Min 6 characters">
                        <span class="toggle-password" onclick="toggleVisibility('reg-password')">üëÅÔ∏è</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="reg-phone" required placeholder="10 digit number">
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="reg-city" required placeholder="City">
                </div>
                <div class="form-group">
                    <label>Stream</label>
                    <select id="reg-stream" required>
                        <option value="" disabled selected>Select Stream</option>
                        <option value="Engineering">Engineering</option>
                        <option value="B.Sc Nursing">B.Sc Nursing</option>
                        <option value="B.Pharma">B.Pharma</option>
                        <option value="Pharm-D">Pharm-D</option>
                        <option value="Farm Science">Farm Science (Agri)</option>
                        <option value="Veterinary">Veterinary Science</option>
                        <option value="BNYS">Naturopathy (BNYS)</option>
                    </select>
                </div>
                <button type="submit" class="btn">Create Account</button>
            </form>
            <button class="btn btn-link" onclick="showScreen('login-screen')">Back to Login</button>
        </div>

        <div id="forgot-screen" class="screen">
            <h2 style="margin-bottom: 10px;">Reset Password</h2>
            <p style="color: var(--text-light); margin-bottom: 20px;">We will send a code to your email.</p>
            <form id="forgot-form">
                <div class="form-group">
                    <label>Registered Email</label>
                    <input type="email" id="forgot-email" required placeholder="john@example.com">
                </div>
                <button type="submit" class="btn">Send Code</button>
            </form>
            <button class="btn btn-link" onclick="showScreen('login-screen')">Cancel</button>
        </div>

        <div id="reset-screen" class="screen">
            <h2 style="margin-bottom: 20px;">Enter Code</h2>
            <form id="reset-form">
                <input type="hidden" id="reset-email-hidden">
                <div class="form-group">
                    <label>6-Digit Code</label>
                    <input type="text" id="reset-code" required placeholder="123456" style="letter-spacing: 5px; text-align: center; font-size: 1.2rem;">
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="new-password" required placeholder="New password">
                        <span class="toggle-password" onclick="toggleVisibility('new-password')">üëÅÔ∏è</span>
                    </div>
                </div>
                <button type="submit" class="btn">Update Password</button>
            </form>
        </div>

        <div id="home-screen" class="screen">
            <div class="dashboard-card">
                <h3 id="welcome-msg" style="margin:0 0 5px 0; color: var(--primary-dark); font-size: 1.4rem;">Hello!</h3>
                <div id="user-details" style="color: var(--text-light); font-size: 0.9rem;">
                    <span id="user-stream-display"></span> ‚Ä¢ <span id="user-city-display"></span>
                </div>
            </div>

            <h3 class="section-title">Study Material</h3>
            <div class="subject-grid">
                <a href="physics.html" class="card-link subject-card">Physics</a>
                <a href="chemistry.html" class="card-link subject-card">Chemistry</a>
                <a href="maths.html" class="card-link subject-card">Mathematics</a>
                <a href="biology.html" class="card-link subject-card">Biology</a>
            </div>

            <h3 class="section-title">Mock Tests</h3>
            <div class="subject-grid">
                <a href="physicstest.html" class="card-link test-card">Physics<br><small>Test</small></a>
                <a href="chemistrytest.html" class="card-link test-card">Chemistry<br><small>Test</small></a>
                <a href="mathstest.html" class="card-link test-card">Maths<br><small>Test</small></a>
                <a href="biologytest.html" class="card-link test-card">Biology<br><small>Test</small></a>
            </div>

            <button class="btn" style="background: #fff; color: #d9534f; border: 2px solid #f5c6cb; margin-top: 40px; box-shadow: none;" onclick="logout()">Log Out</button>
        </div>

    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9DBHrZ2nKXoafiCAWABk6fBFQDmjCtwrixqoBQZKI9Qtlmv7lULjNmxFfetlIhlBI/exec"; 

        // ============================================
        // PWA INSTALL LOGIC
        // ============================================
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');
        const iosMsg = document.getElementById('ios-instruction');
        const installScreen = document.getElementById('install-screen');

        // Check if running in standalone mode (Installed)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

        window.addEventListener('load', () => {
            // 1. SECRET DEVELOPER BACKDOOR
            // If URL has ?dev=true, bypass everything immediately
            if (window.location.search.includes('dev=true')) {
                checkSession();
                return;
            }

            // 2. STANDARD LOGIC
            if (isStandalone) {
                // App is installed -> Go to Login/Home
                checkSession();
            } else {
                // App is in browser -> Show Install Screen
                showScreen('install-screen');
                
                // If iOS, show specific text
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) {
                    iosMsg.style.display = 'block';
                }
            }
        });

        // Listen for Chrome/Android install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Now we can show the button
            installBtn.style.display = 'block';
        });

        // Handle Install Click
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
            }
        });

        // ============================================
        // APP LOGIC
        // ============================================

        function showScreen(screenId) {
            window.scrollTo(0,0);
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function toggleLoader(show) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
        }

        function toggleVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            field.type = field.type === "password" ? "text" : "password";
        }

        async function apiCall(data) {
            toggleLoader(true);
            try {
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                toggleLoader(false);
                return result;
            } catch (error) {
                console.error(error);
                toggleLoader(false);
                alert("Network error. Please check your connection.");
                return { status: "error" };
            }
        }

        // --- AUTH HANDLERS ---

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            const res = await apiCall({ action: "login", email, password });

            if (res.status === "success") {
                localStorage.setItem('kcet_user', JSON.stringify(res.user));
                loadHome(res.user);
            } else {
                alert(res.message);
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                action: "signup",
                name: document.getElementById('reg-name').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
                phone: document.getElementById('reg-phone').value,
                city: document.getElementById('reg-city').value,
                stream: document.getElementById('reg-stream').value
            };
            const res = await apiCall(data);
            if (res.status === "success") {
                alert("Account created! Logging in...");
                const userData = { name: data.name, city: data.city, stream: data.stream };
                localStorage.setItem('kcet_user', JSON.stringify(userData));
                loadHome(userData);
            } else {
                alert(res.message);
            }
        });

        document.getElementById('forgot-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const res = await apiCall({ action: "send_reset_code", email });
            if (res.status === "success") {
                alert(res.message);
                document.getElementById('reset-email-hidden').value = email;
                showScreen('reset-screen');
            } else {
                alert(res.message);
            }
        });

        document.getElementById('reset-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const res = await apiCall({ 
                action: "reset_password", 
                email: document.getElementById('reset-email-hidden').value,
                code: document.getElementById('reset-code').value,
                newPassword: document.getElementById('new-password').value 
            });
            if (res.status === "success") {
                alert("Password reset. Please login.");
                document.getElementById('login-form').reset();
                showScreen('login-screen');
            } else {
                alert(res.message);
            }
        });

        // --- SESSION ---

        function loadHome(user) {
            document.getElementById('welcome-msg').innerText = "Hello, " + user.name;
            document.getElementById('user-stream-display').innerText = user.stream;
            document.getElementById('user-city-display').innerText = user.city;
            showScreen('home-screen');
        }

        function checkSession() {
            const savedUser = localStorage.getItem('kcet_user');
            if (savedUser) {
                loadHome(JSON.parse(savedUser));
            } else {
                showScreen('login-screen');
            }
        }

        function logout() {
            if(confirm("Log out of EziKCET?")) {
                localStorage.removeItem('kcet_user');
                document.getElementById('login-form').reset();
                showScreen('login-screen');
            }
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(console.error);
        }

    </script>
</body>
</html>